(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[17],{9082:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return B}});var a=n(5893),r=n(3206),i=n(4121),s=n(7261),o=n(7294),u=n(8342),l=n(8851),c=n(809),d=n.n(c),f=n(2447),m=n(8528),g=n(1975),x=n(8377),v=n(345);function h(e){var t=e.setFileURL;return(0,a.jsx)("div",{children:(0,a.jsx)(v.Z,{Display:function(){return(0,a.jsx)(x.Z,{Icon:g.Photo})},setFileURL:t,setFile:function(){},setFileSuffix:function(){},accept:"image/x-png, image/jpeg, image/svg+xml"})})}function p(e){var t=e.setFileURL;return(0,a.jsxs)("div",{className:"flex space-x-10",children:[(0,a.jsx)(v.Z,{Display:function(){return(0,a.jsx)(x.Z,{Icon:g.Photo})},setFileURL:t,setFile:function(){},setFileSuffix:function(){},accept:"image/x-png, image/jpeg, image/svg+xml"}),(0,a.jsx)(x.Z,{Icon:g.Close})]})}var j=n(1785);function b(e){var t=e.img,n=e.rectStyle,r=e.save,s=e.Header,u=e.zoomRatio,l=e.setZoomRatio,c=(0,o.useState)([0,0,0,0]),d=c[0],f=c[1],m=(0,o.useRef)(null),g=(0,o.useRef)(null),x=(0,o.useState)([0,0]),v=x[0],h=x[1];(0,o.useEffect)((function(){var e=g.current;if(e&&1!=u){var t=0,n=0,a=(0,i.Z)(d,4),r=a[0],s=a[1],o=a[2],l=a[3],c=e.getBoundingClientRect(),f=c.x,m=c.y,x=c.right,v=c.bottom;f>r&&(t=r-f),m>s&&(n=s-m),x<o&&(t=o-x),v<l&&(n=l-v),b((function(e){var a=(0,i.Z)(e,2),r=a[0],s=a[1];return[r+t,s+n]}))}}),[u]);var p=(0,o.useState)([0,0]),j=p[0],b=p[1],y=(0,o.useState)(!1),w=y[0],N=y[1],Z=(0,o.useState)([0,0]),R=Z[0],S=Z[1],k=function(e,t,n){var a=(0,i.Z)(d,4),r=a[0],s=a[1],o=a[2],u=a[3],l=e.getBoundingClientRect(),c=l.x,f=l.y,m=l.right,g=l.bottom;return[t>0?t+c<r?t:r-c:m+t>o?t:o-m,n>0?n+f<s?n:s-f:g+n>u?n:u-g]};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(s,{crop:function(){return function(){var e=g.current;if(e){var t=(0,i.Z)(d,4),n=t[0],a=t[1],s=t[2],o=t[3],u=e.getBoundingClientRect(),l=u.x,c=u.y,f=u.width,m=u.height,x=e.naturalWidth/f,v=e.naturalHeight/m,h=(n-l)*x,p=(a-c)*v,j=s-n,b=o-a,y=j*x,w=b*v,N=document.createElement("canvas");N.width=j,N.height=b;var Z=N.getContext("2d");Z&&(Z.drawImage(e,h,p,y,w,0,0,j,b),N.toBlob((function(e){return r(N.toDataURL(),e)}),"image/png"))}}()}}),(0,a.jsxs)("div",{className:"relative w-full flex items-center justify-center overflow-hidden cursor-move flex-1",onMouseMove:function(e){if(w){var t=g.current;if(t){var n=(0,i.Z)(R,2),a=n[0],r=n[1],s=e.pageX,o=e.pageY,u=k(t,s-a,o-r),l=(0,i.Z)(u,2),c=l[0],d=l[1];b((function(e){var t=(0,i.Z)(e,2),n=t[0],a=t[1];return[n+c,a+d]})),S([s,o])}}},onWheel:function(e){var t=g.current;if(t){var n=e.deltaY<0?1.02:1/1.02;if(n<1&&u>1){var a=(0,i.Z)(d,4),r=a[0],s=a[1],o=a[2],c=a[3],f=t.getBoundingClientRect(),m=f.x,x=f.y,h=f.right,p=f.bottom,j=f.width,y=f.height,w=(j-j*n)/2,N=(y-y*n)/2,Z=0,R=0;m+w>r&&(Z=-(m+w-r)),x+N>s&&(R=-(x+N-s)),h-w<o&&(Z=o-(h-w)),p-N<c&&(R=c-(p-N)),b((function(e){var t=(0,i.Z)(e,2),n=t[0],a=t[1];return[n+Z,a+R]}))}var S=t.clientWidth*n/v[0];S=Math.min(Math.max(1,S),2),l(S)}},onMouseDown:function(e){0==e.button&&(N(!0),S([e.pageX,e.pageY]))},onMouseUp:function(){return N(!1)},children:[(0,a.jsxs)("section",{className:"absolute top-0 bottom-0 left-0 right-0 flex flex-col z-10",children:[(0,a.jsx)("div",{className:"bg-gray-200 flex-1 opacity-60"}),(0,a.jsxs)("section",{className:"w-full flex",children:[(0,a.jsx)("div",{className:"bg-gray-200 flex-1 opacity-60"}),(0,a.jsx)("main",{className:"border-primary-500",style:n,ref:m}),(0,a.jsx)("div",{className:"bg-gray-200 flex-1 opacity-60"})]}),(0,a.jsx)("div",{className:"bg-gray-200 flex-1 opacity-60"})]}),(0,a.jsx)("img",{style:{maxWidth:"none",width:u*v[0],height:u*v[1],transform:"translate(".concat(j[0],"px, ").concat(j[1],"px)")},src:t,alt:"no image selected",ref:g,onLoad:function(){var e=m.current,t=g.current;if(e&&t){var n=e.getBoundingClientRect(),a=n.x,r=n.y,i=n.right,s=n.bottom,o=n.width,u=n.height;f([a,r,i,s]);var l=o,c=t.naturalHeight*l/t.naturalWidth;c<u&&(c=u,l=t.naturalWidth*c/t.naturalHeight),h([l,c])}}})]})]})}function y(e){var t=e.zoomRatio,n=e.setZoomRatio,r=(0,o.useState)(0),i=r[0],s=r[1],u=(0,o.useState)(!1),l=u[0],c=u[1],d=(0,o.useState)(0),f=d[0],m=d[1],x=(0,o.useRef)(null),v=function(){return c(!1)},h=function(e){if(l){var t=e.pageX-f;console.log(f),n((function(e){return Math.max(1,Math.min(2,e+t/i))})),m(e.pageX)}};return(0,o.useEffect)((function(){var e=x.current.getBoundingClientRect().width;return s(e),window.addEventListener("mousemove",h),window.addEventListener("mouseup",v),function(){window.removeEventListener("mousemove",h),window.removeEventListener("mouseup",v)}}),[l,f]),(0,a.jsxs)("div",{className:"flex items-center justify-center space-x-2 py-2",children:[(0,a.jsx)("div",{className:"w-4",children:(0,a.jsx)(g.ZoomOut,{})}),(0,a.jsxs)("div",{className:"py-2 w-3/5 cursor-pointer relative",onClick:function(e){var t=x.current;if(t){var a=t.getBoundingClientRect(),r=a.x,i=a.width,s=e.pageX;n(1+(s-r)/i)}},children:[(0,a.jsx)("main",{className:"relative bg-primary-100 h-1 rounded-md",ref:x,children:(0,a.jsx)("div",{className:"absolute w-4 h-4 rounded-full bg-primary-500",onMouseDown:function(e){c(!0),m(e.pageX)},style:{top:-6,left:(t-1)*(i-16)}})}),(0,a.jsx)("div",{className:"absolute h-1 w-0 bg-primary-500 left-0 rounded-md",style:{width:(t-1)*(i-12),top:"50%",transform:"translate(0, -50%)"}})]}),(0,a.jsx)("div",{className:"w-4",children:(0,a.jsx)(g.ZoomIn,{})})]})}function w(e){var t=e.img,n=e.save,r=e.back,i=(0,o.useState)(1),s=i[0],u=i[1];return(0,a.jsxs)("div",{className:"fixed-center bg-bg-default rounded-lg flex flex-col select-none",style:{width:620,height:680},children:[(0,a.jsx)(b,{Header:function(e){var t=e.crop;return(0,a.jsx)(m.Z,{title:"Editor Media",close:!1,applyText:"Apply",Back:function(){return r()},Apply:function(){return t()},loading:!1})},img:t,rectStyle:{width:450,height:450,borderWidth:3},save:n,zoomRatio:s,setZoomRatio:u}),(0,a.jsx)(y,{zoomRatio:s,setZoomRatio:u})]})}function N(e){var t=e.img,n=e.save,r=e.back,i=(0,o.useState)(1),s=i[0],u=i[1];return(0,a.jsxs)("div",{className:"fixed-center bg-bg-default rounded-lg flex flex-col select-none",style:{width:650,height:680},children:[(0,a.jsx)(b,{Header:function(e){var t=e.crop;return(0,a.jsx)(m.Z,{title:"Editor Media",close:!1,applyText:"Apply",Back:function(){return r()},Apply:function(){return t()},loading:!1})},img:t,rectStyle:{width:620,height:200,borderWidth:3},save:n,zoomRatio:s,setZoomRatio:u}),(0,a.jsx)(y,{zoomRatio:s,setZoomRatio:u})]})}var Z=n(6829),R=n(2527),S=n(8357);function k(){var e=(0,s.Z)(["\n  mutation ($newInfo: String!) {\n    updateUser(newInfo: $newInfo) {\n      status\n      message\n    }\n  }\n"]);return k=function(){return e},e}var I=(0,R.ZP)(k());function E(e){var t=e.close,n=e.userInfo,r=e.initUserInfo,s=(0,o.useState)("defalut"),u=s[0],l=s[1],c=(0,o.useState)(n.avatar),g=c[0],x=c[1],v=(0,o.useState)(),b=v[0],y=v[1],R=(0,o.useState)(),k=R[0],E=R[1],C=(0,o.useState)(n.backgroundImage),L=C[0],_=C[1],F=(0,o.useState)(),B=F[0],M=F[1],U=(0,o.useState)(),T=U[0],P=U[1],z=(0,o.useState)(n.username),W=z[0],X=z[1],H=(0,o.useState)(n.introduce),A=H[0],D=H[1],O=(0,o.useState)(!1),$=O[0],Y=O[1],q=(0,S.Z)(),J=(q.upLoadingRate,q.postFileToTencentYun),Q=(0,Z.useMutation)(I,{onCompleted:function(e){console.log(e)},onError:function(e){console.log(e.message)}}),G=(0,i.Z)(Q,2),K=G[0],V=G[1].loading,ee=function(){var e=(0,f.Z)(d().mark((function e(){var t;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.username!=W||n.introduce!=A||b||B){e.next=2;break}return e.abrupt("return");case 2:if(n.username===W&&n.introduce===A||(t={username:W,introduce:A},K({variables:{newInfo:JSON.stringify(t)}})),Y(!0),!b){e.next=7;break}return e.next=7,J({file:b,purpose:"avatar",fileExtention:".png"});case 7:if(!B){e.next=10;break}return e.next=10,J({file:B,purpose:"backgroundImage",fileExtention:".png"});case 10:return e.next=12,r();case 12:Y(!1);case 13:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();switch(u){case"edit avatar":return(0,a.jsx)(w,{img:k,back:function(){return l("defalut")},save:function(e,t){x(e),y(t),l("defalut")}});case"edit background":return(0,a.jsx)(N,{img:T,back:function(){return l("defalut")},save:function(e,t){_(e),M(t),l("defalut")}});default:return(0,a.jsxs)("div",{className:"fixed-center w-585 bg-bg-default rounded-2xl py-1 pb-10",children:[(0,a.jsx)(m.Z,{close:!0,title:"Edit profile",applyText:"Save",Back:t,Apply:function(){return ee()},loading:V||$}),(0,a.jsxs)("section",{className:"relative mb-24 p-1",children:[(0,a.jsxs)("div",{className:"h-200 w-full bg-gray-500",children:[L&&(0,a.jsx)("img",{className:"h-200",src:L,alt:"background-img"}),(0,a.jsx)("div",{className:"fixed-center",children:(0,a.jsx)(p,{setFileURL:function(e){P(e),l("edit background")}})})]}),(0,a.jsx)("div",{className:"absolute rounded-full border-4 border-bg-default bottom-_80 left-2",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("img",{className:"rounded-full w-32 h-32",src:g||"/defaultavatar.png",alt:"avatar-img"}),(0,a.jsx)("div",{className:"fixed-center",children:(0,a.jsx)(h,{setFileURL:function(e){E(e),l("edit avatar")}})})]})})]}),(0,a.jsxs)("form",{className:"space-y-5 px-2 my-6",children:[(0,a.jsx)(j.Z,{label:"Name",limit:20,text:W,setText:X,type:"text"}),(0,a.jsx)(j.Z,{label:"Bio",limit:150,text:A,setText:D,type:"text"})]})]})}}function C(){var e=(0,s.Z)(["\n  query ($username: String!) {\n    userInfo(username: $username) {\n      username\n      introduce\n      email\n      avatar\n      backgroundImage\n    }\n  }\n"]);return C=function(){return e},e}var L=(0,R.ZP)(C());function _(e){var t,n,r,s=e.username,c=(0,u.Fg)(),d=c.Lang,f=c.user,m=c.initUserInfo,g=(0,o.useState)(!1),x=g[0],v=g[1],h=(0,o.useState)(0),p=h[0],j=h[1],b=(0,Z.useLazyQuery)(L,{variables:{username:s},fetchPolicy:"cache-and-network",onCompleted:function(e){var t=e.userInfo;t?t.username===f.username?j(1):j(0):j(-1)}}),y=(0,i.Z)(b,2),w=y[0],N=y[1],R=N.loading,S=N.error,k=N.data;return(0,o.useEffect)((function(){w()}),[f]),R?(0,a.jsx)("p",{children:"loading ..."}):S?(0,a.jsxs)("p",{children:["`$",S,"`"]}):(0,a.jsxs)("div",{className:"min-h-full py-px",children:[(0,a.jsxs)("section",{className:"relative mb-14",children:[(0,a.jsx)("div",{className:"h-200 w-full bg-gray-400",children:(null===k||void 0===k||null===(t=k.userInfo)||void 0===t?void 0:t.backgroundImage)&&(0,a.jsx)("img",{className:"h-200 w-full object-cover",src:k.userInfo.backgroundImage,alt:"background-img"})}),(0,a.jsx)("div",{className:"absolute rounded-full border-4  border-bg-default bottom-_50 left-2",children:(0,a.jsx)("img",{className:"rounded-full w-36 h-36",src:(null===k||void 0===k||null===(n=k.userInfo)||void 0===n?void 0:n.avatar)||"/defaultavatar.png",alt:"avatar-img"})})]}),(0,a.jsxs)("section",{className:"relative border-b px-4 pb-5 pt-1",children:[(0,a.jsx)("p",{className:"font-bold text-xl",children:s}),(0,a.jsx)("p",{className:"text-sm py-2",children:null===k||void 0===k||null===(r=k.userInfo)||void 0===r?void 0:r.introduce}),1===p&&(0,a.jsx)("button",{className:"btn-outline absolute right-4 top-_20",onClick:function(){return v(!0)},children:(0,a.jsx)("p",{children:d.profile.editToggle})}),x&&(0,a.jsx)(l.Z,{children:(0,a.jsx)(E,{close:function(){return v(!1)},userInfo:f,initUserInfo:m})})]}),(0,a.jsx)("section",{children:-1===p&&(0,a.jsx)("p",{children:"user not existed!"})})]})}var F=n(1163);function B(){var e=(0,F.useRouter)().asPath,t=e.substring(e.lastIndexOf("/")+1);return(0,a.jsx)(r.Z,{Page:function(){return(0,a.jsx)(_,{username:t})}})}},4007:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/u/[username]",function(){return n(9082)}])}},function(e){e.O(0,[294,206,774,888,179],(function(){return t=4007,e(e.s=t);var t}));var t=e.O();_N_E=t}]);