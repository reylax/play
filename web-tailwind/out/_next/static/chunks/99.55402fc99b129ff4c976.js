(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[99],{1099:function(e,n,r){"use strict";r.r(n),r.d(n,{default:function(){return J}});var t=r(5893),a=r(809),i=r.n(a),o=r(2447),s=r(4121),u=r(5093);var c=r(355);function l(e){return function(e){if(Array.isArray(e))return(0,u.Z)(e)}(e)||function(e){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||(0,c.Z)(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var f=r(7261),d=r(1652),p=r(2964),g=r.n(p),h=r(4919),b=r.n(h),m=r(5547),v=r.n(m),x=r(1854),y=r.n(x),w=r(2534),N=r.n(w),S=r(7294),j=r(5721),k=r(8357),_=r(6829),O=r(2527),E=r(8342);function I(){var e=(0,f.Z)(["\n  mutation ($blog: String!) {\n    publishBlog(blog: $blog) {\n      status,\n      message,\n      _id,\n    }\n  }\n"]);return I=function(){return e},e}var C=(0,O.ZP)(I()),Z=function(e){return e.substring(e.lastIndexOf("/")+1)};function J(){var e={embed:N(),list:g(),header:b(),marker:v(),image:{class:y(),config:{uploader:{uploadByFile:function(e){return m({file:e,purpose:"blog",fileExtention:e.name.substring(e.name.lastIndexOf("."))}).then((function(e){var n=(0,j.rV)("editing_selectedImages");void 0==n&&(n="[]");var r=l(JSON.parse(n));return r.push(Z(e)),(0,j.LS)("editing_selectedImages",JSON.stringify(r)),{success:1,file:{url:"https://avatar-1305219845.cos.ap-shanghai.myqcloud.com"+e}}}))},uploadByUrl:function(e){return new Promise((function(e){e("just use the original url")})).then((function(){return{success:1,file:{url:e}}}))}}}}},n=(0,d.E)(),r=(0,S.useRef)(null),a=(0,S.useCallback)((function(e){r.current=e}),[]),u=(0,_.useMutation)(C,{onError:function(e){console.log(e)}}),c=(0,s.Z)(u,2),f=c[0],p=c[1].loading,h=(0,k.Z)(),m=h.postFileToTencentYun,x=h.deleteTencentYunFile,w=(0,E.Fg)().user,O=w._id,I=w.username,J=w.avatar,A=(0,S.useCallback)((0,o.Z)(i().mark((function e(){var n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.current.save();case 2:n=e.sent,(0,j.LS)("writing_content",JSON.stringify(n));case 4:case"end":return e.stop()}}),e)}))),[]),F=(0,S.useState)((0,j.rV)("writing_title")),L=F[0],T=F[1],V=function(){var e=(0,o.Z)(i().mark((function e(){var n,t;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.current.save();case 2:n=e.sent,P(),t=B(n),f({variables:{blog:JSON.stringify({author:O,title:L,description:t,content:JSON.stringify(n),authorName:I,authorAvatar:J})}});case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),B=function(e){for(var n=0;n<e.blocks.length;n++)if("paragraph"===e.blocks[n].type)return e.blocks[n].data.text;return""},P=function(){var e=(0,o.Z)(i().mark((function e(){var n,t,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.current.save();case 2:n=e.sent,t=new Set,n.blocks.forEach((function(e){"image"===e.type&&t.add(Z(e.data.file.url))})),void 0==(a=(0,j.rV)("editing_selectedImages"))&&(a="[]"),l(JSON.parse(a)).forEach((function(e){t.has(e)||x({purpose:"deleteCanceledImage",fileExtention:e})})),(0,j.LS)("editing_selectedImages",JSON.stringify([]));case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,S.useEffect)((function(){return function(){P()}}),[]),(0,t.jsxs)("div",{className:"w-full h-screen flex flex-col bg-white ",children:[(0,t.jsx)("input",{className:"outline-none font-bold text-2xl px-12 pb-2.5 pt-7 bg-paper-100",placeholder:"\u6807\u9898",value:L,onChange:function(e){var n=e.target.value;(0,j.LS)("writing_title",n),T(n)}}),(0,t.jsx)("div",{className:"bg-white border-t border-b border-primary-50 py-3.5 pl-12 flex-1 overflow-x-hidden overflow-y-scroll scrollbar-hide tracking-widest",onWheel:function(e){return e.stopPropagation()},children:(0,t.jsx)(n,{holder:"editorjs",onInitialize:a,tools:e,placeholder:"\u5199\u70b9\u4ec0\u4e48...",data:JSON.parse((0,j.rV)("writing_content")),onChange:function(){A()}})}),(0,t.jsxs)("div",{className:"p-2 px-5 flex justify-between bg-paper-100",children:[(0,t.jsx)("button",{className:"bg-transparent px-3.5 py-1 border border-red-500 rounded-sm hover:bg-red-50 hover:text-red-500 font-medium",onClick:function(){return r.current.clear()},children:"\u5220\u9664"}),(0,t.jsx)("div",{className:"relative flex justify-center items-center",children:(0,t.jsxs)("button",{className:"bg-green-500 px-3.5 py-1 border border-green-500  hover:bg-green-600 active:bg-green-700 text-white rounded-sm",onClick:function(){return V()},children:[(0,t.jsx)("p",{className:"font-display text-white",children:"\u53d1\u8868"}),(0,t.jsx)("div",{className:"fixed-center",children:p&&(0,t.jsx)("img",{src:"/loading.svg",alt:"pending..."})})]})})]})]})}}}]);